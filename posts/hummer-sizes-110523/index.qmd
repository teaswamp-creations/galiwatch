---
title: Hummingbird sizes 
date: 2023-05-11
author: Cait Harrigan
image: thumbnail.png
toc: true
categories:
  - hummingbirds
  - code
  - data analysis
  - deep-dive
format:
  html:
      code-fold: true
execute:
  warning: false
  message: false
draft: true
---

Reading time: `r ifelse(file.size("index.qmd")/2000 < 1, '<1 minute', paste0(round(file.size("index.qmd")/2000), ' minutes'))`

::: {.callout-note icon=false}
# Series Part 2

This is the second post in this deep-dive series.  
You can start from the beginning with [Part 1](https://galiwatch.ca/posts/hummer-data-cleaning-170323), or skip forward to [Part 3](https://galiwatch.ca/posts/hummer-seasons-140823)
:::

## Setup

As previously covered in Part 1, we're looking at the hummingbird detection data from summer 2021. We did some preliminary data cleaning, and now we'll investigate comparing sizes between species.

```{r, message=F, warning=F}
library(tidyverse)
library(lubridate)
library(patchwork)
library(ggpubr)

# classifier labels
classes = c('Rufous_Male', 'Annas_Male', 'Person_', 'Annas_Female', 'Rufous_Female')

# read in bird detection data, and do some basic data cleaning
bird <- read_csv('https://raw.githubusercontent.com/teaswamp-creations/galiwatch.ca/quarto-website/posts/hummer-behaviour-170323/bird_scaled.csv') 
```

# Bird size!



Note that because of the camera perspective, bounding box area will be affected by not only the bird size, but also its closeness to the camera.


```{r}
bird_scaled %>% 
  mutate(Area = (Height * Width)) %>%
  gghistogram(x="Area", bins = 100) + 
  labs(title = 'Bounding box area after batch correction',
       subtitle = 'Relative rarity of values at 18,000 and 38,000 pixels',
       y = 'Count')
```

Our histogram looks a lot more smooth now. We can still see two dips, as noted previously. The dips we see around 18,000 and 38,000 bounding box size are surprising, this means that there are certain height/width combinations that are not being picked up very frequently. This may indicate that there are certain positions on the feeder at which we can't effectively identify birds.

We see this even more clearly by plotting bird height against width. 

```{r message=F, warning=F}
bird_scaled %>%
  ggscatter(x = "Width", y = "Height",  alpha = 0.6, size=1) +
  labs(title = 'Mid-sized birds are hard to call?') + 
  theme(legend.position = 'right', legend.direction = 'vertical') +
  scale_color_ordinal(option='D')
```

There's some height/widths with no birds observed at them! To check whether this may be related to out classifier's ability to call these birds, we can colour this plot by the confidence level (recall: we already filtered the data such that all ID's have confidence \> 0.7).


```{r message=F, warning=F}
bird_scaled %>%
  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%
  ggscatter(x = "Width", y = "Height", add = "reg.line", alpha = 0.6, color= 'confidence_lvl', size=1,
            add.params = list(color = "black", fill = "lightgray", linetype='dashed')) +
  stat_cor(label.x = 25, label.y = 350) +
  stat_regline_equation(label.x = 25, label.y = 330) + 
  labs(title = 'Mid-sized birds are hard to call?',
       colour = 'Confidence Level') + 
  theme(legend.position = 'right', legend.direction = 'vertical') +
  scale_color_ordinal(option='D')
```

We can see that at least some of these "holes" seem to be associated with lower-confidence IDs, which is consistent with the hypothesis that they're indicative of missing IDs from hard-to-call birds.

In terms of x location, distribution of bird sitting position is strikingly different at different confidence levels. High-confidence calls are much more concentrated at the sides of the feeder than the middle.

```{r}
bird_scaled %>%
  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%
  ggplot(aes(x = xmid, fill = confidence_lvl)) + 
  geom_density(alpha = 0.5) + theme_pubr() + 
  labs(title = 'X position', y = 'Density', fill = 'Confidence Level')
```

On the other hand, it seems that those lower-confidence birds may be over-represented at the small-y (top of image) locations.  

```{r}
bird_scaled %>%
  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%
  ggplot(aes(x = ymid, fill = confidence_lvl)) + 
  geom_density(alpha = 0.5) + theme_pubr() + 
  labs(title = 'Y position', y = 'Density', fill = 'Confidence Level')

```

This corresponds to our low-confidence bird calls coming mostly from a mid-sized bounding box, and towards the back of the feeder. 

```{r}
p1 <- bird_scaled %>% 
  ggplot(aes(x=xmid, y = -ymid, color=Area)) + 
  geom_point() + 
  theme_pubr()

p2 <- bird_scaled %>% 
  ggplot(aes(x=xmid, y = -ymid, color=confidence)) + 
  geom_point(alpha = 0.7) + 
  scale_colour_binned(n.breaks=3, type = "viridis") + 
  theme_pubr()

p1 | p2
```

Notably, there are many low-confidence calls *OFF* the feeder. These are birds who were identified mid-flight! Makes sense that the fast-moving birds might be harder to classify. 

There are also many low-confidence calls in the middle. These birds sit with their back to the camera, and may therefore be harder to identify.


## Summary

We can get a sense of the dynamics at the feeder, just from the pictures we've taken in one summer. 

Stay tuned for the next post in this series, where we'll look into the physical characteristics of these birds!


# Species comparison

We should keep in mind the camera position: birds in the middle of the feeder will likely result in bounding boxes that are taller, while birds on the sides may have a wider "profile view" bounding box:




![](feeder_view.png)

Assuming that preferred sitting position is independent of bird species and sex, we can compare directly the bounding boxes of the different classes. Annas are generally larger than Rufous humming birds, and for each species, the males are smaller than the females. 

```{r}
bird_scaled %>%
  ggplot(aes(x = Sex, y=Height, fill=Species)) +
  geom_boxplot() + 
  theme_pubr() + 
  scale_fill_manual(values=c('chartreuse3', 'chocolate2')) +
  stat_compare_means(method = 't.test', label.y = c(350,350))


```

However, it's this may be an imperfect assumption: 

```{r}
bird_scaled %>%
  ggplot(aes(x = xmid, y=-ymid, colour = Species)) + 
  geom_point() + 
  scale_colour_manual(values=c('chartreuse3', 'chocolate2')) +
  facet_wrap(~Sex) + 
  theme_pubr() + 
  labs(title = 'Annas are not identified in the middle as often as Rufous')

```

Annas aren't identified in the middle as often as Rufouses are. This could be be because they don't sit there as often, but more likely they're just chanllenging to identify when they're facing away from the camera.




## Distribution of sitting spots

We can plot the location of where each bird sits, with the proxy that a birds will be located at the center of its bounding box. The birds appear to mostly sit in a circle, around the rim of the feeder. This makes sense, as it gives the best access to the sugar water.

```{r}
bird %>% 
  ggscatter(x='xmid', y='ymid', alpha=0.4, color ='y_size')
```

However, it looks like there are at least 2 distinct positions that the feeder was in over the summer. We'll try to do batch correction for this, by assigning a batch number to each position, and subtract the average from the x and y direction. I think we can reasonably split the changes in position (the batches) simply by the date. This is easy to see in the ymid variable - the feeder moves twice in May, and once in June.

```{r}
bird %>% 
  mutate(Month = month(Date, label=T)) %>%
  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%
  ggplot(aes(x=Timestamp, y = ymid))+ 
  geom_jitter(alpha = 0.5) + 
  facet_wrap("~Month", scales = 'free_x') + 
  theme_pubr() + 
  labs(title = 'Feeder Moves Up and Down in May and June')
```

Lets split these into batches for correction.

```{r batching}
bird$batch <- 1
bird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-08 00:00:00'),2,bird$batch)
bird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-11 00:00:00'),3,bird$batch)
bird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-06-13 12:20:00'),4,bird$batch)
bird$batch <- factor(bird$batch)
```

We can check it went as expected by recolouring the previous plot by batch

```{r}
bird %>% 
  mutate(Month = month(Date, label=T)) %>%
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>% 
  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%
  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ 
  geom_point(alpha = 0.5) + 
  facet_wrap("~Month", scales = 'free_x') + 
  theme_pubr() + 
  labs(title = 'We can Infer Position Batches Based on When the Feeder Moves',
       colour = 'Batch')
```

Now we're ready to correct! We'll transform all the x- and y- values by centering and scaling each batch. This will yield a new positioning relative to the middle of the feeder; we can no longer interpret this as the pixel index in the image.

```{r}
bird_scaled <- bird %>% 
  mutate(Month = month(Date, label=T)) %>%
  group_by(batch) %>%
  mutate(ymin1 = ymax, ymax1=ymin) %>%
  mutate(across(c(xmin, xmax, ymin, ymax), ~ scale(.x)) ) %>%
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2)


bird_scaled %>% 
  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%
  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ 
  geom_point(alpha = 0.5) + 
  facet_wrap("~Month", scales = 'free_x') + 
  theme_pubr() + 
  labs(title = 'Batch corrected for feeder position',
       colour = 'Batch')
```

We can see that the correction didn't perfectly fix things - but it looks pretty good!

```{r}
p1 <- bird %>%
  ggplot(aes(x=xmid, y=ymid) ) +
  stat_density_2d(aes(fill=batch), geom = "polygon", alpha=0.2) + 
  theme_pubr() + 
  labs(title = 'Bird density before batch correction', fill = 'Batch')

p2 <- bird_scaled %>%
  ggplot(aes(x=xmid, y=ymid) ) +
  stat_density_2d(aes(fill=batch), geom = "polygon", alpha=0.2) + 
  theme_pubr() + 
  labs(title = 'Bird density after batch correction',fill = 'Batch')

p1 | p2

```




The gap in the middle comes from the water column - we can't detect birds sitting behind it! Of course, we have to be somewhat careful when converting back to the coordinates of the image. I negate the y coordinates, because they count from the top of the image. 

```{r, eval=T, warning=F}
img <- jpeg::readJPEG('feeder.jpg')

bird_scaled %>%
  ggplot(aes(x=xmid, y = -ymid)) + 
  ylim(-1.8,8) + xlim(-1.8, 1.8) +
  background_image(img) + 
  geom_point(shape = 'x') 

```

## Bird size!

Now that we have our corrected bounding boxes, we can have a look at bird sizes!

Going back to the same height/width plot we saw last time, the "holes" are nearly gone, but the mid-sized birds are the hardest to classify with high certainty.

```{r, warning=F}
bird_scaled <- bird_scaled %>%
  mutate(
    Height = ymax-ymin, 
    Width = xmax-xmin, 
    Area = abs(Height * Width)) %>%
  mutate(confidence_lvl = cut(confidence, c(0, 0.7, 0.8, 0.9, 1), ordered_result=T)) 

bird_scaled %>%
  ggscatter(x = "Width", y = "Height", add = "reg.line", alpha = 0.2, color= 'confidence_lvl',
            add.params = list(color = "black", fill = "lightgray", linetype='dashed')) +
  #stat_cor(label.x = .25, label.y = 450) +
  #stat_regline_equation(label.x = .25, label.y = 400) + 
  labs(title = 'Mid-sized birds are hard-to call?',
       colour = 'Confidence Level') 


bird %>%
  mutate(
    Height = ymax-ymin, 
    Width = xmax-xmin, 
    Area = abs(Height * Width)) %>%
  mutate(confidence_lvl = cut(confidence, c(0, 0.7, 0.8, 0.9, 1), ordered_result=T))%>%
  ggscatter(y = "Area", x = "confidence", add = "reg.line", alpha = 0.2,
            add.params = list(color = "black", fill = "lightgray", linetype='dashed'))
```


Our low-confidence bird calls seem to be concentrated to a mid-sized bounding box, and towards the back of the feeder. 

```{r}
p1 <- bird_scaled %>% 
  mutate(area_lvl = cut(Area, c(0, 0.05, 0.1, 0.2, 0.5, 1), ordered_result=T, include.lowest = T)) %>%
  ggplot(aes(x=xmid, y = ymid, color=area_lvl)) + 
  geom_point(alpha = 0.2) + 
  theme_pubr() + theme(legend.position = 'none')

p2 <- bird_scaled %>% 
  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%
  ggplot(aes(x=xmid, y = ymid, color=confidence_lvl)) + 
  geom_point(alpha = 0.2) + 
  theme_pubr() + theme(legend.position = 'none')


p1 | p2
```

```{r, eval=F}
bird <- bird %>% 
  mutate(
         xmid = (xmax+xmin)/2, 
         ymid = (ymax+ymin)/2,
         Width = xmax - xmin, 
         Height = ymax - ymin
  )


bird %>%mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%
  ggscatter(x='xmid', y='Area', color ='ymid') + 
  facet_wrap(~Species)
```

Although Annas are generally larger than Rufous humming birds, we have to keep in mind the camera position. Birds in the middle of the feeder will likely result in bounding boxes that are taller, while birds on the sides may have a wider "profile view" bounding box:

![](feeder_view.png)

```{r, eval=T}

# how to make circle plot: pick center of box, plot x/y
# most interested in feet: on the left - feet are on the left. 
# if you're on the right, your feet are on the right. Could probably pick the center

# change female -> female + immature male

bird_scaled %>% 
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%
  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%
  ggplot() + 
  aes(x=xmid, y = Width, xmax, colour = Sex) +
  geom_point(alpha = 0.5) + 
  facet_wrap(~Species) +
  labs(title = 'Birds are wider on the sides of the feeder', subtitle = '(profile view?)')

bird_scaled %>% 
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%
  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%
  ggplot(alpha = 0.5) + 
  aes(x=xmid, y = Height, xmax, colour = Sex) +
  geom_point() + 
  facet_wrap(~Species) +
  labs(title = 'Annas are taller (and don\'t get ID\'d sitting middle)')


bird_scaled %>% 
  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%
  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%
  ggplot(alpha = 0.5) + 
  aes(x=xmid, y = ymid, xmax, colour = Sex) +
  geom_point() + 
  facet_wrap(~Species) +
  labs(title = 'Birds mostly sit on the feeder', subtitle = "Annas are sometimes ID\'d in flight")

```


:::{.callout-note icon=false}
## Read on to [Part 3 <i class="fa-solid fa-arrow-right"></i>]() 
:::



# Bird size!



Note that because of the camera perspective, bounding box area will be affected by not only the bird size, but also its closeness to the camera.


```{r}
bird_scaled %>% 
  mutate(Area = (Height * Width)) %>%
  gghistogram(x="Area", bins = 100) + 
  labs(title = 'Bounding box area after batch correction',
       subtitle = 'Relative rarity of values at 18,000 and 38,000 pixels',
       y = 'Count')
```

Our histogram looks a lot more smooth now. We can still see two dips, as noted previously. The dips we see around 18,000 and 38,000 bounding box size are surprising, this means that there are certain height/width combinations that are not being picked up very frequently. This may indicate that there are certain positions on the feeder at which we can't effectively identify birds.

We see this even more clearly by plotting bird height against width. 

```{r message=F, warning=F}
bird_scaled %>%
  ggscatter(x = "Width", y = "Height",  alpha = 0.6, size=1) +
  labs(title = 'Mid-sized birds are hard to call?') + 
  theme(legend.position = 'right', legend.direction = 'vertical') +
  scale_color_ordinal(option='D')
```

There's some height/widths with no birds observed at them! To check whether this may be related to out classifier's ability to call these birds, we can colour this plot by the confidence level (recall: we already filtered the data such that all ID's have confidence \> 0.7).


```{r message=F, warning=F}
bird_scaled %>%
  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%
  ggscatter(x = "Width", y = "Height", add = "reg.line", alpha = 0.6, color= 'confidence_lvl', size=1,
            add.params = list(color = "black", fill = "lightgray", linetype='dashed')) +
  stat_cor(label.x = 25, label.y = 350) +
  stat_regline_equation(label.x = 25, label.y = 330) + 
  labs(title = 'Mid-sized birds are hard to call?',
       colour = 'Confidence Level') + 
  theme(legend.position = 'right', legend.direction = 'vertical') +
  scale_color_ordinal(option='D')
```

We can see that at least some of these "holes" seem to be associated with lower-confidence IDs, which is consistent with the hypothesis that they're indicative of missing IDs from hard-to-call birds.

In terms of x location, distribution of bird sitting position is strikingly different at different confidence levels. High-confidence calls are much more concentrated at the sides of the feeder than the middle.

```{r}
bird_scaled %>%
  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%
  ggplot(aes(x = xmid, fill = confidence_lvl)) + 
  geom_density(alpha = 0.5) + theme_pubr() + 
  labs(title = 'X position', y = 'Density', fill = 'Confidence Level')
```

On the other hand, it seems that those lower-confidence birds may be over-represented at the small-y (top of image) locations.  

```{r}
bird_scaled %>%
  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%
  ggplot(aes(x = ymid, fill = confidence_lvl)) + 
  geom_density(alpha = 0.5) + theme_pubr() + 
  labs(title = 'Y position', y = 'Density', fill = 'Confidence Level')

```

This corresponds to our low-confidence bird calls coming mostly from a mid-sized bounding box, and towards the back of the feeder. 

```{r}
p1 <- bird_scaled %>% 
  ggplot(aes(x=xmid, y = -ymid, color=Area)) + 
  geom_point() + 
  theme_pubr()

p2 <- bird_scaled %>% 
  ggplot(aes(x=xmid, y = -ymid, color=confidence)) + 
  geom_point(alpha = 0.7) + 
  scale_colour_binned(n.breaks=3, type = "viridis") + 
  theme_pubr()

p1 | p2
```

Notably, there are many low-confidence calls *OFF* the feeder. These are birds who were identified mid-flight! Makes sense that the fast-moving birds might be harder to classify. 

There are also many low-confidence calls in the middle. These birds sit with their back to the camera, and may therefore be harder to identify.


## Summary

We can get a sense of the dynamics at the feeder, just from the pictures we've taken in one summer. 

Stay tuned for the next post in this series, where we'll look into the physical characteristics of these birds!

