{
  "hash": "ed17e2af9d6b6f49fb0f737537f48c46",
  "result": {
    "markdown": "---\ntitle: Which birds where? \ndate: 2023-05-11\nauthor: Cait Harrigan\nimage: thumbnail.png\ntoc: true\ncategories:\n  - birds\n  - code\n  - data analysis\n  - deep-dive\nformat:\n  html:\n      code-fold: true\nexecute:\n  warning: false\n  message: false\ndraft: true\n---\n\n\nReading time: 5 minutes\n\n::: {.callout-note icon=false}\n# Series Part 2\n\nThis is the second post in this deep-dive series.  \nSee here for [series overview](https://galiwatch.ca/posts/hummer-behaviour-170323/), or skip forward to [Part 3]()\n:::\n\n## Setup\n\nAs previously covered in part i, we're looking at the hummingbird detection data from 2021. We did some preliminary data exploration, and saw some interesting patterns in the visit times of different birds.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(patchwork)\nlibrary(ggpubr)\n\n# classifier labels\nclasses = c('Rufous_Male', 'Annas_Male', 'Person_', 'Annas_Female', 'Rufous_Female')\n\n# read in bird detection data, and do some basic data cleaning\nbird <- read_csv('https://raw.githubusercontent.com/teaswamp-creations/galiwatch.ca/quarto-website/posts/hummer-behaviour-170323/2021_reprocessed_hummers_combo_2023.csv') %>% \n  # lookup labels\n  mutate(class = classes[label + 1]) %>%\n  # put columns into tidy format\n  separate(class, into=c('Species', 'Sex'), sep='_') %>%\n  separate(image, into=c('Date', 'image'), sep=\"_\", remove = F) %>%\n  separate(image, into=c('hhmm'), sep=\".jpg\", extra = 'drop') %>%\n  # clean up timestamps\n  mutate(Timestamp = ymd_hm(paste(Date, hhmm))) %>%\n  # remove people\n  filter(label != 2) %>%\n  # change column types, correct for variable image size\n  mutate(Date=ymd(Date),\n         Month=factor(month(Date, label = T)),\n         Hour=hour(Timestamp),\n         Species = ordered(Species),\n         Sex = factor(Sex),\n         MergeTime = floor_date(Timestamp, 'hour'),\n         xmid = (xmax+xmin)/2, \n         ymid = (ymax+ymin)/2\n  ) \n```\n:::\n\n\n## Distribution of sitting spots\n\nWe can plot the location of where each bird sits, with the proxy that a birds will be located at the center of its bounding box. The birds appear to mostly sit in a circle, around the rim of the feeder. This makes sense, as it gives the best access to the sugar water.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>% \n  ggscatter(x='xmid', y='ymid', alpha=0.4, color ='y_size')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nHowever, it looks like there are at least 2 distinct positions that the feeder was in over the summer. We'll try to do batch correction for this, by assigning a batch number to each position, and subtract the average from the x and y direction. I think we can reasonably split the changes in position (the batches) simply by the date. This is easy to see in the ymid variable - the feeder moves twice in May, and once in June.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>% \n  mutate(Month = month(Date, label=T)) %>%\n  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%\n  ggplot(aes(x=Timestamp, y = ymid))+ \n  geom_jitter(alpha = 0.5) + \n  facet_wrap(\"~Month\", scales = 'free_x') + \n  theme_pubr() + \n  labs(title = 'Feeder Moves Up and Down in May and June')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nLets split these into batches for correction.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird$batch <- 1\nbird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-08 00:00:00'),2,bird$batch)\nbird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-11 00:00:00'),3,bird$batch)\nbird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-06-13 12:20:00'),4,bird$batch)\nbird$batch <- factor(bird$batch)\n```\n:::\n\n\nWe can check it went as expected by recolouring the previous plot by batch\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>% \n  mutate(Month = month(Date, label=T)) %>%\n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>% \n  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%\n  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ \n  geom_point(alpha = 0.5) + \n  facet_wrap(\"~Month\", scales = 'free_x') + \n  theme_pubr() + \n  labs(title = 'We can Infer Position Batches Based on When the Feeder Moves',\n       colour = 'Batch')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nNow we're ready to correct! We'll transform all the x- and y- values by centering and scaling each batch. This will yield a new positioning relative to the middle of the feeder; we can no longer interpret this as the pixel index in the image.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled <- bird %>% \n  mutate(Month = month(Date, label=T)) %>%\n  group_by(batch) %>%\n  mutate(ymin1 = ymax, ymax1=ymin) %>%\n  mutate(across(c(xmin, xmax, ymin, ymax), ~ scale(.x)) ) %>%\n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2)\n\n\nbird_scaled %>% \n  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%\n  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ \n  geom_point(alpha = 0.5) + \n  facet_wrap(\"~Month\", scales = 'free_x') + \n  theme_pubr() + \n  labs(title = 'Batch corrected for feeder position',\n       colour = 'Batch')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nWe can see that the correction didn't perfectly fix things - but it looks pretty good!\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- bird %>%\n  ggplot(aes(x=xmid, y=ymid) ) +\n  stat_density_2d(aes(fill=batch), geom = \"polygon\", alpha=0.2) + \n  theme_pubr() + \n  labs(title = 'Bird density before batch correction', fill = 'Batch')\n\np2 <- bird_scaled %>%\n  ggplot(aes(x=xmid, y=ymid) ) +\n  stat_density_2d(aes(fill=batch), geom = \"polygon\", alpha=0.2) + \n  theme_pubr() + \n  labs(title = 'Bird density after batch correction',fill = 'Batch')\n\np1 | p2\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\nThe gap in the middle comes from the water column - we can't detect birds sitting behind it! Of course, we have to be somewhat careful when converting back to the coordinates of the image. I negate the y coordinates, because they count from the top of the image. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nimg <- jpeg::readJPEG('feeder.jpg')\n\nbird_scaled %>%\n  ggplot(aes(x=xmid, y = -ymid)) + \n  ylim(-1.8,8) + xlim(-1.8, 1.8) +\n  background_image(img) + \n  geom_point(shape = 'x') \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n## Bird size!\n\nNow that we have our corrected bounding boxes, we can have a look at bird sizes!\n\nGoing back to the same height/width plot we saw last time, the \"holes\" are nearly gone, but the mid-sized birds are the hardest to classify with high certainty.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled <- bird_scaled %>%\n  mutate(\n    Height = ymax-ymin, \n    Width = xmax-xmin, \n    Area = abs(Height * Width)) %>%\n  mutate(confidence_lvl = cut(confidence, c(0, 0.7, 0.8, 0.9, 1), ordered_result=T)) \n\nbird_scaled %>%\n  ggscatter(x = \"Width\", y = \"Height\", add = \"reg.line\", alpha = 0.2, color= 'confidence_lvl',\n            add.params = list(color = \"black\", fill = \"lightgray\", linetype='dashed')) +\n  #stat_cor(label.x = .25, label.y = 450) +\n  #stat_regline_equation(label.x = .25, label.y = 400) + \n  labs(title = 'Mid-sized birds are hard-to call?',\n       colour = 'Confidence Level') \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbird %>%\n  mutate(\n    Height = ymax-ymin, \n    Width = xmax-xmin, \n    Area = abs(Height * Width)) %>%\n  mutate(confidence_lvl = cut(confidence, c(0, 0.7, 0.8, 0.9, 1), ordered_result=T))%>%\n  ggscatter(y = \"Area\", x = \"confidence\", add = \"reg.line\", alpha = 0.2,\n            add.params = list(color = \"black\", fill = \"lightgray\", linetype='dashed'))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-2.png){width=672}\n:::\n:::\n\n\n\nOur low-confidence bird calls seem to be concentrated to a mid-sized bounding box, and towards the back of the feeder. \n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- bird_scaled %>% \n  mutate(area_lvl = cut(Area, c(0, 0.05, 0.1, 0.2, 0.5, 1), ordered_result=T, include.lowest = T)) %>%\n  ggplot(aes(x=xmid, y = ymid, color=area_lvl)) + \n  geom_point(alpha = 0.2) + \n  theme_pubr() + theme(legend.position = 'none')\n\np2 <- bird_scaled %>% \n  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%\n  ggplot(aes(x=xmid, y = ymid, color=confidence_lvl)) + \n  geom_point(alpha = 0.2) + \n  theme_pubr() + theme(legend.position = 'none')\n\n\np1 | p2\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbird <- bird %>% \n  mutate(\n         xmid = (xmax+xmin)/2, \n         ymid = (ymax+ymin)/2,\n         Width = xmax - xmin, \n         Height = ymax - ymin\n  )\n\n\nbird %>%mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%\n  ggscatter(x='xmid', y='Area', color ='ymid') + \n  facet_wrap(~Species)\n```\n:::\n\n\nAlthough Annas are generally larger than Rufous humming birds, we have to keep in mind the camera position. Birds in the middle of the feeder will likely result in bounding boxes that are taller, while birds on the sides may have a wider \"profile view\" bounding box:\n\n![](feeder_view.png)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# how to make circle plot: pick center of box, plot x/y\n# most interested in feet: on the left - feet are on the left. \n# if you're on the right, your feet are on the right. Could probably pick the center\n\n# change female -> female + immature male\n\nbird_scaled %>% \n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%\n  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%\n  ggplot() + \n  aes(x=xmid, y = Width, xmax, colour = Sex) +\n  geom_point(alpha = 0.5) + \n  facet_wrap(~Species) +\n  labs(title = 'Birds are wider on the sides of the feeder', subtitle = '(profile view?)')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbird_scaled %>% \n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%\n  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%\n  ggplot(alpha = 0.5) + \n  aes(x=xmid, y = Height, xmax, colour = Sex) +\n  geom_point() + \n  facet_wrap(~Species) +\n  labs(title = 'Annas are taller (and don\\'t get ID\\'d sitting middle)')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-2.png){width=672}\n:::\n\n```{.r .cell-code}\nbird_scaled %>% \n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>%\n  mutate(Width = xmax - xmin, Height = ymax - ymin) %>%\n  ggplot(alpha = 0.5) + \n  aes(x=xmid, y = ymid, xmax, colour = Sex) +\n  geom_point() + \n  facet_wrap(~Species) +\n  labs(title = 'Birds mostly sit on the feeder', subtitle = \"Annas are sometimes ID\\'d in flight\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-3.png){width=672}\n:::\n:::\n\n\n\n:::{.callout-note icon=false}\n## Read on to [Part 3 <i class=\"fa-solid fa-arrow-right\"></i>]() \n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}