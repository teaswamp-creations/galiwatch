{
  "hash": "d0e99bccd9666b5e813714c169d56804",
  "result": {
    "markdown": "---\ntitle: Tracking hummingbirds at the feeder \ndate: 2023-03-17\nauthor: Cait Harrigan\nimage: thumbnail.png\ntoc: true\ncategories:\n  - hummingbirds\n  - code\n  - data analysis\n  - deep-dive\nformat:\n  html:\n      code-fold: true\nexecute:\n  warning: false\n  message: false\ndraft: true\n---\n\n\nReading time: 16 minutes\n\n::: {.callout-note icon=false}\n# Series overview\n\nThis is the first post in this deep-dive series. We'll cover a few different things:\n\n1. Data cleaning (this post)\n1. Bird sizes\n1. Migration behaviour\n1. Weather effects\n1. Territorial birds!  \n:::\n\nAll the data analyzed here was collected in 2021. In the future, we may be able to learn more by comparing across different years. We have images from the hummingbird feeder, and micro-climate data collected from the weather station. \n\n# Background\n\nThere are two species of hummingbirds found near Galiano: the green [Anna's Hummingbird](https://en.wikipedia.org/wiki/Anna%27s_hummingbird) and the orange [Rufous Hummingbird](https://en.wikipedia.org/wiki/Rufous_hummingbird). ID images from [allaboutbirds.org](https://www.allaboutbirds.org/).\n\n::: {layout-ncol=\"2\"}\n![](anna_id.png)\n\n![](rufous_id.png)\n:::\n\nWe set up a camera to capture these feathery fellows visiting our hummingbird feeder.\n\n![A Female Anna's (left) and Male Rufus (right) at our feeder](ar_2.jpg)\n\nWe trained a classifier to detect who's who....\n\n::: {layout-ncol=\"3\"}\n![](2021-06-10_1201_hbird.jpg)\n\n![](2021-09-06_1243_hbird.jpg)\n\n![](2021-09-06_1930_hbird.jpg)\n:::\n\nAnd we're even able to keep track of when the feeder needs a refill!\n\n<center>![](water_level.gif){width=\"400\"}</center>\n\n<br>\n\nLets dive in to some of the data we've collected!\n\n\n## Setup\n\nWe'll read in our data: the classifier output as well as bounding boxes of detected birds.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(patchwork)\nlibrary(ggpubr)\n```\n:::\n\n\n\nRead in and prepare the camera data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# classifier labels\nclasses = c('Rufous_Male', 'Annas_Male', 'Person', 'Annas_Female', 'Rufous_Female')\n\n# read in bird detection data, and do some basic data cleaning\nbird <- #read_csv('https://raw.githubusercontent.com/teaswamp-creations/galiwatch.ca/quarto-website/posts/hummer-behaviour-170323/2021_reprocessed_hummers_combo_2023.csv') %>% \n  read_csv('2021_reprocessed_hummers_combo_2023.csv') %>% \n  # lookup labels\n  mutate(class = classes[label + 1]) %>%\n  # put columns into tidy format\n  separate(class, into=c('Species', 'Sex'), sep='_') %>%\n  separate(image, into=c('Date', 'image'), sep=\"_\", remove = F) %>%\n  separate(image, into=c('hhmm'), sep=\".jpg\", extra = 'drop') %>%\n  # clean up timestamps\n  mutate(Timestamp = ymd_hm(paste(Date, hhmm))) %>%\n  # remove people\n  filter(label != 2) %>%\n  # change column types, correct for variable image size\n  mutate(Date=ymd(Date),\n         Month=factor(month(Date, label = T)),\n         Hour=hour(Timestamp),\n         Species = ordered(Species),\n         Sex = factor(Sex),\n         MergeTime = floor_date(Timestamp, 'hour'),\n         # y values are flipped\n         \n         xmid = (xmax+xmin)/2, \n         ymid = (ymax+ymin)/2\n  ) \n```\n:::\n\n\nLets take a peek at the data. \n\nThe bird detector gives us the the bounding box of each bird in an image, and the predicted sex and species of the bird. Note that because it's hard to distinguish female birds from the immature males, there are likely some which are misclassified.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::kable(head(bird))\n```\n\n::: {.cell-output-display}\n|Date       |hhmm | xmin| ymin| xmax| ymax| label| confidence| x_size| y_size|Mo | OK|Species |Sex  |Timestamp           |Month | Hour|MergeTime           |  xmid|  ymid|\n|:----------|:----|----:|----:|----:|----:|-----:|----------:|------:|------:|:--|--:|:-------|:----|:-------------------|:-----|----:|:-------------------|-----:|-----:|\n|2021-04-20 |1651 |  154|  365|  331|  514|     0|  0.8494033|    820|    616|04 |  1|Rufous  |Male |2021-04-20 16:51:00 |Apr   |   16|2021-04-20 16:00:00 | 242.5| 439.5|\n|2021-04-20 |1706 |  200|  382|  406|  478|     0|  0.8925107|    820|    616|04 |  1|Rufous  |Male |2021-04-20 17:06:00 |Apr   |   17|2021-04-20 17:00:00 | 303.0| 430.0|\n|2021-04-20 |1718 |  634|  401|  814|  552|     0|  0.9755894|    820|    616|04 |  1|Rufous  |Male |2021-04-20 17:18:00 |Apr   |   17|2021-04-20 17:00:00 | 724.0| 476.5|\n|2021-04-20 |1914 |  164|  389|  368|  507|     0|  0.6146710|    820|    616|04 |  1|Rufous  |Male |2021-04-20 19:14:00 |Apr   |   19|2021-04-20 19:00:00 | 266.0| 448.0|\n|2021-04-20 |1925 |  196|  389|  408|  472|     0|  0.9455948|    820|    616|04 |  1|Rufous  |Male |2021-04-20 19:25:00 |Apr   |   19|2021-04-20 19:00:00 | 302.0| 430.5|\n|2021-04-20 |1942 |  177|  402|  378|  539|     0|  0.9968680|    820|    616|04 |  1|Rufous  |Male |2021-04-20 19:42:00 |Apr   |   19|2021-04-20 19:00:00 | 277.5| 470.5|\n:::\n:::\n\n\n## Number of birds by species\n\nOur bird detector ID'd lots of visitors! Each ID represents a bird captured in an image, and not necessarily an individual. The images are captured once every minute, so if for example a single bird sat at the feeder for two minutes in a row, it would get counted twice. There may be multiple birds in a single image.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn_table <- bird %>%\n  group_by(Species, Sex) %>%\n  summarise('Number of ids' = n(), .groups = 'keep')\n\nn_table %>%\n  kableExtra::kbl() %>%\n  kableExtra::kable_styling(full_width = F)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Species </th>\n   <th style=\"text-align:left;\"> Sex </th>\n   <th style=\"text-align:right;\"> Number of ids </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Annas </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 4127 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Annas </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 1792 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rufous </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 11720 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rufous </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 1081 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n:::{.callout-tip}\n\nThere are more Rufouses than Annas, and many more females than males captured in our images.\n\n:::\n\n## Classifier confidence\n\nEach bird ID is made by picking the the most likely label, based on the prediction probability. Sometimes, the classifier isn't as confident as others. For example, it may be harder to identify a bird that is facing away from the camera. We can plot the confidences, and see which birds are the hardest to label.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>%\n  gghistogram(x = 'confidence', fill = 'Species', color='Species', bins=100,\n              facet.by = c('Sex','Species'), scales = 'free_y', alpha=1, position='stack') +\n  labs(title = 'Prediction for females may be better calibrated',\n       subtitle = 'Higher proportion of low-confidence IDs for males vs females of both species', \n       x = 'Prediction confidence', y = 'Number of IDs') + \n  theme(legend.position = 'right') + \n  scale_fill_manual(values=c('chartreuse3', 'chocolate2')) + \n  scale_colour_manual(values=c('chartreuse3', 'chocolate2'))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nIt looks like for both species, Male birds are slightly harder to identify with high confidence than Female. \n**There are many more Female examples than Male in our data, and More Rufous than Anna.**\n\nThere is almost certainly some mistakes in our classifier, including false positives (non-birds labeled as birds) and false negatives (birds that are missed)\n\nTo help make sure we're only considering high-quality calls, we'll pick a confidence threshold of 0.7 and only analyse the IDs above that level.\n\n## Number of birds after filtering\n\nWe manually looked at the images, and found that that almost all the Rufouses after September 1st are false positives, so we'll remove these observations. Also, since we have very few IDs in October, we will drop this month from our data. Then, we'll filter to only retain the high-confidence (\\> 0.7 prediction probability) bird IDs\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird <- bird %>%\n  filter(!(Timestamp >= ymd('2021-09-01') & Species =='Rufous')) %>%\n  filter(Timestamp < ymd('2021-10-01')) %>%\n  filter(confidence > 0.7)\n```\n:::\n\n\nLastly, we'll sanity check the bounding boxes for their size.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird <- bird %>%\n  mutate(\n    Height = ymax-ymin, \n    Width = xmax-xmin, \n    Area = Height * Width\n  )\n\nbird %>% \n  gghistogram(x=\"Area\", bins = 100) + \n  labs(title = 'There are some very small and some very large bounding boxes.',\n       subtitle = \"Note also relative raity of areas at 25,000 and 50,000 pixels\", y = 'Count')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nThis distribution more or less makes sense, we see some very small bounding boxes which may be mis-calls or birds who are only half in the image. There are also some cases where a bird is partially obscured because it's sitting behind the feeder. There are some very large bounding boxes also. I'm not sure exactly whether these are real, giant humming birds, or some kind of artifact.\n\nLets see if looking at the bird position with respect to the feeder helps sort this out. \n\n\n## Distribution of sitting spots\n\nWe can plot the location of where each bird sits, with the proxy that a birds will be located at the center of its bounding box. The birds appear to mostly sit in a circle, around the rim of the feeder. This makes sense, as it gives the best access to the sugar water.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>% ggplot(aes(x = xmid, y = -ymid, colour=y_size * x_size)) +\n  geom_point() +\n  theme_pubr() + \n  labs(colour = 'Image size (pixels)') + \n  scale_colour_binned(n.breaks=3) + \n  theme(legend.position = 'right', legend.direction = 'vertical') \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nHowever, it looks like there are at least 2 distinct positions that the feeder was in over the summer. We'll try to do batch correction for this, by assigning a batch number to each position, and subtract the average from the x and y direction. I think we can reasonably split the changes in position (the batches) simply by the date. This is easy to see in the ymid variable - the feeder moves twice in May, and once in June.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>% \n  mutate(Month = month(Date, label=T)) %>%\n  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%\n  ggplot(aes(x=Timestamp, y = ymid))+ \n  geom_jitter(alpha = 0.5) + \n  facet_wrap(\"~Month\", scales = 'free_x') + \n  theme_pubr() + \n  labs(title = 'Feeder Moves Up and Down in May and June')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nLets split these into batches for correction.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird$batch <- 1\nbird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-08 00:00:00'),2,bird$batch)\nbird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-05-11 00:00:00'),3,bird$batch)\nbird$batch <- ifelse(bird$Timestamp > ymd_hms('2021-06-13 12:20:00'),4,bird$batch)\nbird$batch <- factor(bird$batch)\n```\n:::\n\n\nWe can check it went as expected by recolouring the previous plot by batch\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>% \n  mutate(Month = month(Date, label=T)) %>%\n  mutate(xmid = (xmax+xmin)/2, ymid = (ymax+ymin)/2) %>% \n  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%\n  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ \n  geom_point(alpha = 0.5) + \n  facet_wrap(\"~Month\", scales = 'free_x') + \n  theme_pubr() + \n  labs(title = 'We can Infer Position Batches Based on When the Feeder Moves',\n       colour = 'Batch')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nNow we're ready to correct! We'll transform all the x- and y- values by centering and scaling each batch. This will yield a new positioning relative to the middle of the feeder; we can no longer interpret this as the pixel index in the image. We'll normalize the \"mid\" locations, then add the size of the bounding box back. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled <- bird %>% \n  mutate(Month = month(Date, label=T)) %>%\n  mutate(Height = ymax-ymin, Width = xmax-xmin) %>%\n  group_by(batch) %>%\n  mutate(across(c(Height, Width, xmid, ymid), ~scale(.x))) %>%\n  mutate(xmin = xmid - Width/2, xmax = xmid + Width/2, \n         ymin = ymid - Height/2, ymax = ymid + Height/2)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled %>% \n  filter(Date>'2021-05-01' & Date<'2021-06-15') %>%\n  ggplot(aes(x=Timestamp, y = ymid, color=batch))+ \n  geom_point(alpha = 0.5) + \n  facet_wrap(\"~Month\", scales = 'free_x') + \n  theme_pubr() + \n  labs(title = 'Batch corrected for feeder position',\n       colour = 'Batch')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nWe can see that the correction didn't perfectly fix things - but it looks pretty good! From now on, we'll use the `bird_scaled` dataframe. \n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- bird %>%\n  ggplot(aes(x=xmid, y=ymid) ) +\n  stat_density_2d(aes(fill=batch), geom = \"polygon\", alpha=0.2) + \n  theme_pubr() + \n  labs(title = 'Bird density before batch correction', fill = 'Batch')\n\np2 <- bird_scaled %>%\n  ggplot(aes(x=xmid, y=ymid) ) +\n  stat_density_2d(aes(fill=batch), geom = \"polygon\", alpha=0.2) + \n  theme_pubr() + \n  labs(title = 'Bird density before batch correction',fill = 'Batch')\n\np1 | p2\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\nThe gap in the middle comes from the water column - we can't detect birds sitting behind it! Of course, we have to be somewhat careful when converting back to the coordinates of the image. I negate the y coordinates, because they count from the top of the image. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nimg <- jpeg::readJPEG('feeder.jpg')\n\nbird_scaled %>%\n  ggplot(aes(x=xmid, y = -ymid)) + \n  ylim(-2, 10) + \n  background_image(img) + \n  geom_point(colour = 'lightblue') \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\nNow we have our corrected bounding boxes! However, since we z-score normalized height and width, there are some negative values. This doesn't make sense, so we'll bring these back to the original space by using `ungroup` to add back the (pooled) mean and standard deviation. At the same time, we can filter out some extreme values (>2 sd from mean).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled <- bird %>% \n  mutate(Month = month(Date, label=T)) %>%\n  mutate(Height = ymax-ymin, Width = xmax-xmin, \n         original_aspect_ratio = Height/Width) %>%\n  group_by(batch) %>%\n  mutate(across(c(Height, Width, xmid, ymid), ~scale(.x))) %>%\n  filter(abs(Height)<=2) %>%\n  filter(abs(Width)<=2) %>%\n  ungroup() %>%\n  mutate(across(c(Height, Width, xmid, ymid), ~(.x * sd(bird$.x)) + mean(bird$.x))) %>%\n  mutate(xmin = xmid - Width/2, xmax = xmid + Width/2, \n         ymin = ymid - Height/2, ymax = ymid + Height/2)\n```\n:::\n\n\nSince we normalized height and width independently, We should check that aspect ratio is preserved. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled %>%\n  mutate(scaled_aspect_ratio = Height/Width) %>%\n  ggscatter(x='scaled_aspect_ratio', y='original_aspect_ratio', alpha = 0.3,\n            color='batch', add='reg.line', add.params = list(color='black', linetype='dashed')) + \n  stat_cor(label.y=3.4) +\n  stat_regline_equation()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\nPretty well correlated! There are some boxes that may have got warped through the normalization, especially in batch 2, but for the most part looks good. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled %>% \n  gghistogram(x=\"log2(Height / Width)\", bins = 100) + \n  labs(title = 'Bounding box aspect ratios after batch correction',\n       subtile = 'Relative rarity of values at 18,000 and 38,000',\n       y = 'Count') +\n  annotate(\"segment\", x = -0.2, xend = -2, y = 430, yend = 430, size = 1.2,\n           colour = \"red\", arrow = arrow(type='closed', length=unit(0.04, 'npc'))) + annotate('text', label = 'wide and short', colour = 'red', x = -1, y = 450) +\n  annotate(\"segment\", x = 0.2, xend = 2, y = 430, yend = 430, size = 1.2,\n           colour = \"red\", arrow = arrow(type='closed', length=unit(0.04, 'npc'))) + annotate('text', label = 'tall and thin', colour = 'red', x = 1, y = 450)  + \n  annotate('text', label='square', x = 0, y = 450, colour = 'red')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\nThere are more wide and short bounding boxes than tall and thin ones. \n\nAfter all this filtering, here's the final numbers of each class label:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn_table %>% \n  bind_cols(\n    bird_scaled %>%\n    group_by(Species, Sex) %>%\n    summarise(n=n(), .groups = 'keep') %>%\n    pull(n)\n  ) %>%\n  rename(`Before filtering` = `Number of ids`,\n         `After filtering` = `...4`) %>%\n  kableExtra::kbl() %>%\n  kableExtra::kable_styling(full_width = F)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Species </th>\n   <th style=\"text-align:left;\"> Sex </th>\n   <th style=\"text-align:right;\"> Before filtering </th>\n   <th style=\"text-align:right;\"> After filtering </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Annas </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 4127 </td>\n   <td style=\"text-align:right;\"> 2924 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Annas </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 1792 </td>\n   <td style=\"text-align:right;\"> 833 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rufous </td>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:right;\"> 11720 </td>\n   <td style=\"text-align:right;\"> 9598 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rufous </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 1081 </td>\n   <td style=\"text-align:right;\"> 634 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Summary\n\n\n\n:::{.callout-note}\n## Read on to [part ii]()\n:::\n\n# Bird size!\n\n\n\nNote that because of the camera perspective, bounding box area will be affected by not only the bird size, but also its closeness to the camera.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled %>% \n  mutate(Area = (Height * Width)) %>%\n  gghistogram(x=\"Area\", bins = 100) + \n  labs(title = 'Bounding box area after batch correction',\n       subtitle = 'Relative rarity of values at 18,000 and 38,000 pixels',\n       y = 'Count')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\nOur histogram looks a lot more smooth now. We can still see two dips, as noted previously. The dips we see around 18,000 and 38,000 bounding box size are surprising, this means that there are certain height/width combinations that are not being picked up very frequently. This may indicate that there are certain positions on the feeder at which we can't effectively identify birds.\n\nWe see this even more clearly by plotting bird height against width. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled %>%\n  ggscatter(x = \"Width\", y = \"Height\",  alpha = 0.6, size=1) +\n  labs(title = 'Mid-sized birds are hard to call?') + \n  theme(legend.position = 'right', legend.direction = 'vertical') +\n  scale_color_ordinal(option='D')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\nThere's some height/widths with no birds observed at them! To check whether this may be related to out classifier's ability to call these birds, we can colour this plot by the confidence level (recall: we already filtered the data such that all ID's have confidence \\> 0.7).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled %>%\n  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%\n  ggscatter(x = \"Width\", y = \"Height\", add = \"reg.line\", alpha = 0.6, color= 'confidence_lvl', size=1,\n            add.params = list(color = \"black\", fill = \"lightgray\", linetype='dashed')) +\n  stat_cor(label.x = 25, label.y = 350) +\n  stat_regline_equation(label.x = 25, label.y = 330) + \n  labs(title = 'Mid-sized birds are hard to call?',\n       colour = 'Confidence Level') + \n  theme(legend.position = 'right', legend.direction = 'vertical') +\n  scale_color_ordinal(option='D')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\nWe can see that at least some of these \"holes\" seem to be associated with lower-confidence IDs, which is consistent with the hypothesis that they're indicative of missing IDs from hard-to-call birds.\n\nIn terms of x location, distribution of bird sitting position is strikingly different at different confidence levels. High-confidence calls are much more concentrated at the sides of the feeder than the middle.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled %>%\n  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%\n  ggplot(aes(x = xmid, fill = confidence_lvl)) + \n  geom_density(alpha = 0.5) + theme_pubr() + \n  labs(title = 'X position', y = 'Density', fill = 'Confidence Level')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\nOn the other hand, it seems that those lower-confidence birds may be over-represented at the small-y (top of image) locations.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled %>%\n  mutate(confidence_lvl = cut(confidence, c(0.6, 0.7, 0.8, 0.9, 1), ordered_result=T)) %>%\n  ggplot(aes(x = ymid, fill = confidence_lvl)) + \n  geom_density(alpha = 0.5) + theme_pubr() + \n  labs(title = 'Y position', y = 'Density', fill = 'Confidence Level')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\nThis corresponds to our low-confidence bird calls coming mostly from a mid-sized bounding box, and towards the back of the feeder. \n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- bird_scaled %>% \n  ggplot(aes(x=xmid, y = -ymid, color=Area)) + \n  geom_point() + \n  theme_pubr()\n\np2 <- bird_scaled %>% \n  ggplot(aes(x=xmid, y = -ymid, color=confidence)) + \n  geom_point(alpha = 0.7) + \n  scale_colour_binned(n.breaks=3, type = \"viridis\") + \n  theme_pubr()\n\np1 | p2\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\nNotably, there are many low-confidence calls *OFF* the feeder. These are birds who were identified mid-flight! Makes sense that the fast-moving birds might be harder to classify. \n\nThere are also many low-confidence calls in the middle. These birds sit with their back to the camera, and may therefore be harder to identify.\n\n\n## Summary\n\nWe can get a sense of the dynamics at the feeder, just from the pictures we've taken in one summer. \n\nStay tuned for the next post in this series, where we'll look into the physical characteristics of these birds!\n\n\n# Species comparison\n\nWe should keep in mind the camera position: birds in the middle of the feeder will likely result in bounding boxes that are taller, while birds on the sides may have a wider \"profile view\" bounding box:\n\n\n\n\n![](feeder_view.png)\n\nAssuming that preferred sitting position is independent of bird species and sex, we can compare directly the bounding boxes of the different classes. Annas are generally larger than Rufous humming birds, and for each species, the males are smaller than the females. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled %>%\n  ggplot(aes(x = Sex, y=Height, fill=Species)) +\n  geom_boxplot() + \n  theme_pubr() + \n  scale_fill_manual(values=c('chartreuse3', 'chocolate2')) +\n  stat_compare_means(method = 't.test', label.y = c(350,350))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\nHowever, it's this may be an imperfect assumption: \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled %>%\n  ggplot(aes(x = xmid, y=-ymid, colour = Species)) + \n  geom_point() + \n  scale_colour_manual(values=c('chartreuse3', 'chocolate2')) +\n  facet_wrap(~Sex) + \n  theme_pubr() + \n  labs(title = 'Annas are not identified in the middle as often as Rufous')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\nAnnas aren't identified in the middle as often as Rufouses are. This could be be because they don't sit there as often, but more likely they're just chanllenging to identify when they're facing away from the camera.\n\n## Migration patterns\n\nThe Anna and Rufous hummingbirds have two quite distinct migration patterns: Annas are year-round visitors to our feeder in BC, while the Rufouses tend to leave for Mexico about half way through the summer.\n\n::: {layout-ncol=\"2\"}\n![](anna_range.png)\n\n![](rufous_range.png)\n\nAdapted from Wikipedia\n:::\n\n## Visit patterns over the summer\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- bird %>%\n  ggplot() + \n  aes(x = Date, fill = Species) + \n  geom_histogram(bins=100, position='dodge') + \n  labs(y='Number of IDs', x='', title='Rufous Migrates Away in July',\n       subtitle = 'Annas are present in BC year-round') + \n  scale_fill_manual(values=c('chartreuse3', 'chocolate2')) + \n  #facet_wrap('~Species') +\n  theme_pubr() \n\np2 <- bird %>% \n  ggplot() + \n  aes(x = Date, fill = Species, y=after_stat(count)) + \n  geom_density(bw=10, position='fill', show.legend = F, colour =NA) + \n  labs(y='Proportion of IDs') + \n  scale_fill_manual(values=c('chartreuse3', 'chocolate2'))+ \n  theme_pubr()\n\n\n(p1 / p2) \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\nHere's a map made from citizen scientist data: each blue dot is a Rufous sighting reported to iNaturalist.\n\n![](species_locations.gif) \n\n\nThe Male Rufous leave earlier than the Female: they're almost all gone by July. The latest dates we have for *manually confirmed* Rufous visits are:\n\n-   Male: July 5th 2021\n-   Female : July 31st 2021\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- bird %>% \n  filter(Species == 'Rufous') %>%\n  group_by(Month, Sex) %>% \n  filter(n() > 5) %>%\n  ggplot() + \n  aes(x = Month, fill = Sex, y=after_stat(count)) + \n  geom_bar(position='fill', colour =NA)  + \n  labs(y='Proportion of IDs') + \n  scale_fill_manual(values=c('chocolate1', 'chocolate4'))+ \n  theme_pubr() + labs(title='Rufous')\n\np2 <- bird %>% \n  filter(Species == 'Annas') %>%\n  group_by(Month, Sex) %>% \n  filter(n() > 5) %>%\n  ggplot() + \n  aes(x = Month, fill = Sex, y=after_stat(count)) + \n  geom_bar(position='fill', colour =NA) + \n  labs(y='Proportion of IDs') + \n  scale_fill_manual(values=c('chartreuse1', 'chartreuse4'))+ \n  theme_pubr() + labs(title='Anna')\n\n(p1) + (p2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\nThe Annas on the other hand, seem to hover around 1:3 Male to Female ID ratio, with the dramatic exception of April. This may have to do with female nesting behaviours, but we don't know for sure.\n\n## Visiting Hours\n\nI thought the hours of the day in which birds visit the feeder might give interesting insight into their behaviour. After poking around in the data, I found that visiting hours vary widely from month-to-month. In both species, we see a big dip in visits from 12-3pm in June. Our hypothesis is that this has to do with avoiding the sun or hottest temperatures in the middle of the day. June was an especially hot month for 2021, and there were lots of [forest fires](https://galiwatch.ca/posts/fires-2021). However, it's somewhat surprising to not also see this effect in July and August, which are generally similar to June in terms of weather.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>%\n  filter(Species == 'Rufous') %>%\n  filter(Date < ymd('2021-08-01')) %>% \n  ggplot(aes(x=Hour, fill = Sex)) + \n  geom_bar(position = 'stack') + facet_wrap(\"~Month\", scales='free_y') +\n  scale_fill_manual(values=c('chocolate1', 'chocolate4')) + \n  labs(title='Rufous visit times vary by month', y = 'Number of IDs') + \n  theme_pubr()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-29-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>%\n  filter(Species == 'Annas') %>%\n  ggplot(aes(x=Hour, fill = Sex)) + \n  geom_bar(position='stack') + facet_wrap(\"~Month\", scales='free_y') + \n  scale_fill_manual(values=c('chartreuse1', 'chartreuse4')) + \n  labs(title='Annas visit times vary by month', y = 'Number of IDs') + \n  theme_pubr()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-30-1.png){width=672}\n:::\n:::\n\n\n## \n\n\nNow we'll make use of the data from our weather station. I've created a column `MergeTime` in both dataframes, to make it easy to merge the bird and weather data.\n\nRead in and prepare the weather data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nweather <- #readr::read_csv('https://raw.githubusercontent.com/teaswamp-creations/galiwatch.ca/quarto-website/posts/hummer-behaviour-170323/WS_hours.csv') %>%\n  read_csv('WS_hours.csv') %>%\n  # retain only non-duplicates\n  distinct() %>%\n  # Clean up timestamps, convert to celsius\n  mutate(Date = ymd(Date), \n         MergeTime = ymd_hms(paste(Date, Time)),\n         `Temp C` = (`Outdoor Temperature F`-32) * (5/9)\n         )\n```\n:::\n\n\nThe air quality measures show the concentration of particulates at three different size thresholds (in micrometers), as well as the outdoor air temperature recorded from April - December 2021.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::kable(head(weather))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Date </th>\n   <th style=\"text-align:left;\"> Time </th>\n   <th style=\"text-align:right;\"> Indoor Temperature F </th>\n   <th style=\"text-align:right;\"> Indoor Humidity % </th>\n   <th style=\"text-align:right;\"> Outdoor Temperature F </th>\n   <th style=\"text-align:right;\"> Outdoor Humidity % </th>\n   <th style=\"text-align:right;\"> Wind Speed(mph) </th>\n   <th style=\"text-align:right;\"> wind direction(Degree) </th>\n   <th style=\"text-align:right;\"> Light Intensity </th>\n   <th style=\"text-align:right;\"> UV index </th>\n   <th style=\"text-align:left;\"> Daily Rainfall accumulation </th>\n   <th style=\"text-align:right;\"> Total Accumulative Rainfall </th>\n   <th style=\"text-align:left;\"> Strike Count now </th>\n   <th style=\"text-align:left;\"> Daily Strike Count </th>\n   <th style=\"text-align:left;\"> Total Strike Count </th>\n   <th style=\"text-align:right;\"> Closet Strike distance </th>\n   <th style=\"text-align:left;\"> Interference </th>\n   <th style=\"text-align:right;\"> barometric Pressure(real) </th>\n   <th style=\"text-align:right;\"> Calibrated barometric Pressure </th>\n   <th style=\"text-align:left;\"> Dew Point </th>\n   <th style=\"text-align:right;\"> Rain Rate </th>\n   <th style=\"text-align:right;\"> wind gust </th>\n   <th style=\"text-align:right;\"> Wind Speed average </th>\n   <th style=\"text-align:right;\"> Feels like </th>\n   <th style=\"text-align:left;\"> Heat Index </th>\n   <th style=\"text-align:left;\"> Wind Chill </th>\n   <th style=\"text-align:left;\"> ...27 </th>\n   <th style=\"text-align:left;\"> MergeTime </th>\n   <th style=\"text-align:right;\"> Temp C </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 2021-02-14 </td>\n   <td style=\"text-align:left;\"> 19:00:00 </td>\n   <td style=\"text-align:right;\"> 62 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n   <td style=\"text-align:right;\"> 60.7 </td>\n   <td style=\"text-align:right;\"> 47 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 93 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 29.62 </td>\n   <td style=\"text-align:right;\"> 29.91 </td>\n   <td style=\"text-align:left;\"> 38 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 58 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> NA </td>\n   <td style=\"text-align:left;\"> 2021-02-14 19:00:00 </td>\n   <td style=\"text-align:right;\"> 15.94444 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2021-02-14 </td>\n   <td style=\"text-align:left;\"> 20:00:00 </td>\n   <td style=\"text-align:right;\"> 63 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n   <td style=\"text-align:right;\"> 62.8 </td>\n   <td style=\"text-align:right;\"> 48 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 93 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 29.59 </td>\n   <td style=\"text-align:right;\"> 29.89 </td>\n   <td style=\"text-align:left;\"> 42 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 61 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> NA </td>\n   <td style=\"text-align:left;\"> 2021-02-14 20:00:00 </td>\n   <td style=\"text-align:right;\"> 17.11111 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2021-02-14 </td>\n   <td style=\"text-align:left;\"> 21:00:00 </td>\n   <td style=\"text-align:right;\"> 66 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n   <td style=\"text-align:right;\"> 68.7 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 99 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 29.58 </td>\n   <td style=\"text-align:right;\"> 29.89 </td>\n   <td style=\"text-align:left;\"> 46 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 67 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> NA </td>\n   <td style=\"text-align:left;\"> 2021-02-14 21:00:00 </td>\n   <td style=\"text-align:right;\"> 20.38889 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2021-02-14 </td>\n   <td style=\"text-align:left;\"> 22:00:00 </td>\n   <td style=\"text-align:right;\"> 67 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n   <td style=\"text-align:right;\"> 72.0 </td>\n   <td style=\"text-align:right;\"> 42 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 99 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 29.58 </td>\n   <td style=\"text-align:right;\"> 29.90 </td>\n   <td style=\"text-align:left;\"> 47 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 71 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> NA </td>\n   <td style=\"text-align:left;\"> 2021-02-14 22:00:00 </td>\n   <td style=\"text-align:right;\"> 22.22222 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2021-02-14 </td>\n   <td style=\"text-align:left;\"> 23:00:00 </td>\n   <td style=\"text-align:right;\"> 67 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n   <td style=\"text-align:right;\"> 72.1 </td>\n   <td style=\"text-align:right;\"> 42 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 99 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 29.56 </td>\n   <td style=\"text-align:right;\"> 29.88 </td>\n   <td style=\"text-align:left;\"> 47 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 71 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> NA </td>\n   <td style=\"text-align:left;\"> 2021-02-14 23:00:00 </td>\n   <td style=\"text-align:right;\"> 22.27778 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2021-02-15 </td>\n   <td style=\"text-align:left;\"> 00:00:00 </td>\n   <td style=\"text-align:right;\"> 67 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n   <td style=\"text-align:right;\"> 72.8 </td>\n   <td style=\"text-align:right;\"> 41 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 99 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> --.-- </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:right;\"> 29.54 </td>\n   <td style=\"text-align:right;\"> 29.87 </td>\n   <td style=\"text-align:left;\"> 46 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 72 </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> -- </td>\n   <td style=\"text-align:left;\"> NA </td>\n   <td style=\"text-align:left;\"> 2021-02-15 00:00:00 </td>\n   <td style=\"text-align:right;\"> 22.66667 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Temperature preferences\n\nBased on the visiting hours plots, it seems like there may be a temperature effect in play, especially in June. To look into this, I made some linear regressions by month. There seemed to be some strong negative correlation in the hot months of June, July, August!\n\nRelationship between temperature and number of visits differs by month.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmerge(bird, weather, all.x=T) %>%\n  filter(Species=='Rufous') %>%\n  filter(Date < ymd('2021-08-01')) %>% \n  group_by(Month, Hour, Species) %>%\n  summarise(n=n(), temp = median(`Temp C`, na.rm=T), .groups='keep') %>%\n  ggplot(aes(x=temp, y = n))+ \n  geom_point(colour = 'chocolate2') + \n  geom_smooth(method='lm', colour = 'chocolate4') +\n  labs(title='Rufous', x='Temperature (C)', y = 'Number of Visits')+\n  facet_wrap(\"Month\", nrow=2, scales = \"free_y\")+\n  theme_pubr()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-33-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmerge(bird, weather, all.x=T) %>%\n  filter(Species=='Annas') %>%\n  group_by(Month, Hour, Species) %>%\n  summarise(n=n(), temp = median(`Temp C`, na.rm=T), .groups='keep') %>%\n  ggplot(aes(x=temp, y = n))+ \n  geom_point(colour = 'chartreuse3') + \n  geom_smooth(method='lm', colour = 'chartreuse4') +\n  labs(title='Anna', x='Temperature (C)', y = 'Number of Visits')+\n  facet_wrap(\"Month\", scales = \"free_y\")+ \n  theme_pubr()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-34-1.png){width=672}\n:::\n:::\n\n\nBoth species seem to dislike temperatures above 20 degrees C. There's a fairly strong month-specific effect - this may reflect some behaviour changes based on the Rufous migration\n\n# bird\n\n::: callout-note\nThis is the second post in this deep-dive series. See here for [part ii](https://galiwatch.ca/posts/hummer-behaviour-170323/)\n:::\n\n## Setup\n\nAs previously covered in part i, we're looking at the hummingbird detection data from 2021. We did some preliminary data exploration, and saw some interesting patterns in the visit times of different birds.\n\n\n## Continuation of hummer-watch data analysis!\n\n## Number of birds in an image for each class\n\nRufous males can be very territorial. We'd like to know whether we can see evidence of the \"chasing away\" behaviour.\n\nIf this is the case, then the disappearance of the male rufous should lead to an increase in the *absolute number* of Annas who come (but might not affect the number of female rufous. And the later disappearance of the female rufous should also lead to an increase in the number of Annas.\n\nBecause it's hard to see this on a minute-to-minute basis, we'll summarize the number of Anna visits by day.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_c <- merge(bird_scaled, weather, all.x=T)\n# number of birds per day \n\nbird_c %>% \n  group_by(Date, Species, Sex) %>%\n  summarise(n=n(), `Temp C` = max(`Temp C`), .groups='keep') %>%\n  ggplot() + \n  aes(x = Date, y = n, fill = Sex) + \n  geom_bar(stat = 'identity') +\n  facet_wrap(~Species) + \n  labs(y = 'Number of bird visits', title = 'Most Rufous visit in Summer, Female Annas visit in Fall,\\nMale Annas are year-round')\n\n# Not really what happened\n\nbird_c %>% \n  group_by(Date, Species, Sex) %>%\n  summarise(n=n(), `Temp C` = max(`Temp C`), .groups='keep') %>%\n  ggplot() + \n  aes(x = n, y = `Temp C`, colour = Sex) + \n  geom_point() + \n  geom_smooth(method = 'lm', formula = 'y~x', se = F, linetype='dashed') +\n  facet_wrap(~Species, scales = 'free_x') + \n  labs(x = 'Number of bird visits', title = 'Everyone except Female Annas prefers lower temperatures')\n```\n:::\n\nBird co-occurance: how many share an image with another?\nFor each month, does the 2+ mixture match the single bird mixture\n\nRufouses probably chase off annas, and maybe the females more so. Seen in the seasonal trend, but this might be migration. But also seen in the difference between the ratio of membership in the single vs. multi occupancy images. \nSee the every month the rufouses are around. Never see more than 3 annas in one image. \n\nThis is also apparent on an hourly level!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbird_scaled %>%\n  mutate(rufous_migrated = (Date >= ymd('2021-07-31'))) %>%\n  group_by(Date, hhmm, Species, Sex, rufous_migrated) %>%\n  summarise(n=n()) %>%\n  ggplot(aes(x=factor(n), fill=Species)) + \n  geom_bar() +\n  #facet_wrap(~month(Date, label = T))\n  facet_wrap(~rufous_migrated) + \n  theme_pubr()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-36-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbird_scaled %>%\n  mutate(rufous_migrated = (Date >= ymd('2021-07-31'))) %>%\n  filter(Species=='Annas') %>%\n  group_by(Date, Hour, rufous_migrated, Sex) %>%\n  summarise(n=n()) %>%\n  ggplot(aes(x=factor(n), fill=Sex)) + \n  geom_bar() +\n  #facet_wrap(~month(Date, label = T))\n  facet_wrap(Sex~rufous_migrated) + \n  theme_pubr()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-36-2.png){width=672}\n:::\n\n```{.r .cell-code}\nbird_scaled %>%\n  group_by(Date, Hour, Species, Sex) %>%\n  summarise(n=n()) %>%\n  ggplot(aes(x=factor(n), fill=Species)) + \n  geom_bar(position='fill') +\n  #facet_wrap(~month(Date, label = T))\n  facet_wrap(month(Date, label = T)~Sex) + \n  theme_pubr()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-36-3.png){width=672}\n:::\n:::\n\n\nfit a poisson model to each and evaluate if rate paranmeter is different!\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# total number of birds per day\nbird %>%\n  filter(Species=='Annas') %>%\n  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%\n  group_by(Date,`Rufous Males present`, Sex, .groups='keep') %>%\n  summarize(n=n()) %>%\n  ggplot(aes(x=`Rufous Males present`, y = n)) +\n  geom_rect(aes(fill = Sex),xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf, show.legend = F) + \n  geom_boxplot() + \n  facet_wrap(\"~Sex\") + \n  stat_compare_means(method = \"t.test\", label.y = 180, label.x = 1.3) + \n  geom_bracket(xmin = 1, xmax = 2, label = '', y.position = c(170)) +\n  theme_pubr() + \n  labs(title='Rufous Males are better at scaring off Female Annas than Male Annas') + \n  scale_fill_manual(values = c('chartreuse1', 'chartreuse4'))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-37-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# average number of birds per image per day\nbird %>%\n  filter(Species=='Annas') %>%\n  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%\n  \n  group_by(Date,`Rufous Males present`, Timestamp, Sex, .groups='keep') %>%\n  summarize(n=n()) %>%\n  group_by(Date, `Rufous Males present`, Sex) %>%\n  summarize(n=mean(n), .groups = 'keep') %>%\n  \n  ggplot(aes(x=`Rufous Males present`, y = n)) +\n  geom_rect(aes(fill = Sex),xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf, show.legend = F) + \n  geom_boxplot() + \n  facet_wrap(\"~Sex\") + \n  stat_compare_means(method = \"t.test\", label.y = 1.41, label.x = 1.3) + \n  geom_bracket(xmin = 1, xmax = 2, label = '', y.position = 1.4) +\n  theme_pubr() + \n  labs(title='Rufous Males are better at scaring off Female Annas than Male Annas') + \n  scale_fill_manual(values = c('chartreuse1', 'chartreuse4'))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-37-2.png){width=672}\n:::\n\n```{.r .cell-code}\nbird %>%\n  group_by(Date, Timestamp, Species, .groups='keep') %>%\n  summarize(n=n()) %>%\n  #group_by(Date, Species) %>%\n  #summarize(n=mean(n), .groups = 'keep') %>%\n  ggplot(aes(x=factor(Date), y = n, colour=Species)) + \n  geom_point()+\n  geom_smooth(aes(colour =Species), method='lm', formula='y~poly(x,4)')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-37-3.png){width=672}\n:::\n\n```{.r .cell-code}\nbird %>%\n  #filter(Species=='Annas') %>%\n  mutate('Rufous Males present' = Date < ymd('2021-07-31')) %>%\n  group_by(Date, `Rufous Males present`, Species, Sex) %>%\n  summarize(n=n()) %>%\n  ggplot(aes(x=`Rufous Males present`, y = n)) +\n  geom_boxplot() +\n  facet_grid(rows =vars(Species), cols = vars(Sex), scales='free')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-37-4.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbird  %>%group_by(Timestamp, Species, Sex) %>% summarize(n=n()) %>% ggplot() +aes(x = Timestamp, y=n, color = Species, fill=Species) + geom_bar(stat='identity') + facet_wrap('~Sex') +scale_color_manual(values=c('chartreuse2', 'chocolate3'))+scale_fill_manual(values=c('chartreuse2', 'chocolate3'))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-38-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>%\n  group_by(Date, Month = factor(month(Timestamp, label=T)), Hour= hour(Timestamp), Species, Sex) %>%\n  summarise(n=n(), .groups='keep') %>%\n  group_by(Month, Hour, Species, Sex,.groups='keep') %>%\n  summarize(mean_n = mean(n)) %>%\n  ggplot(aes(x=Hour, y = mean_n, colour = Month)) + \n  geom_point() + geom_line() + \n  facet_grid(rows = vars(Species), cols = vars(Sex), scales = 'free')+ \n  labs(y='average number of IDs per day')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-39-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbird %>%\n  mutate(Hour = hour(Timestamp), Month = factor(month(Timestamp, label=T))) %>%\n  group_by(Month, Hour, Species, Sex) %>%\n  summarise(n=n()) %>%\n  ggplot(aes(x = Hour, y = Month, fill=Month, color =Month)) +\n  ggridges::geom_density_ridges(alpha= 0.2) + \n  facet_grid(rows = vars(Species), cols = vars(Sex))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-40-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbird %>%\n  mutate(Hour = hour(Timestamp), Month = factor(month(Timestamp, label=T))) %>%\n  ggplot() +\n  aes(x=Hour, fill=Month) +\n  geom_bar() + \n  theme_pubr() + theme(legend.position = 'right') +\n  facet_wrap('~Species', scale='free') +\n  labs(x = 'Hour of Day', y = 'Count', title = 'Daylight changes over the months!')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-40-2.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\r\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}